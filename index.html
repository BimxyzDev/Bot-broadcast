<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Telegram Broadcast - Full</title>
  <style>
    :root{
      --primary:#0b76d1;
      --accent:#ff8a00;
      --danger:#e03b3b;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f4f7fb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,#eef6ff,#fbfdff);padding:18px;color:#0b1220}
    .wrap{max-width:980px;margin:0 auto}
    .container{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(16,24,40,0.08)}
    h1{margin:0 0 8px;color:var(--primary)}
    label{display:block;margin-top:10px;font-weight:600}
    input[type="number"], textarea, select {width:100%;padding:10px;border-radius:8px;border:1px solid #dde6f2;font-size:14px}
    textarea{resize:none;min-height:90px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .col{flex:1;min-width:140px}
    .actions{display:flex;gap:10px;margin-top:12px}
    button{padding:10px 14px;border-radius:8px;border:none;background:var(--primary);color:#fff;cursor:pointer;font-weight:700}
    button.stop{background:var(--danger)}
    button.ghost{background:#10b981}
    #status{margin-top:10px;font-weight:700;color:var(--muted)}
    .panel{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:16px}
    .left, .right{padding:12px;border-radius:10px;background:#fff;box-shadow:0 6px 18px rgba(16,24,40,0.04)}
    .card{margin-bottom:12px;padding:10px;border-radius:8px;border:1px solid #f1f5f9}
    .broadcast-list{max-height:520px;overflow:auto;padding-right:6px}
    .b-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;border:1px solid #eef4fb;margin-bottom:8px;background:linear-gradient(180deg,#fff,#fbfdff)}
    .b-left{display:flex;gap:12px;align-items:center;max-width:70%}
    .badge{width:48px;height:48px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
    .badge.msg{background:linear-gradient(135deg,var(--primary),#3da0ff)}
    .b-meta{font-size:13px;overflow:hidden}
    .b-meta .title{font-weight:800;color:#0b1220;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .b-meta .small{color:var(--muted);font-size:12px;margin-top:4px}
    .b-right{text-align:right;min-width:150px}
    .countdown{font-weight:800;color:var(--accent);font-size:15px}
    .status-sending{color:#6b21a8;font-weight:800}
    .status-idle{color:var(--muted)}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;font-size:12px;background:#f1f5f9;color:#0b1220;margin-left:8px}
    .tiny{font-size:12px;color:var(--muted)}
    .history-item{padding:8px;border-bottom:1px solid #f1f5f9}
    .muted-note{font-size:13px;color:var(--muted)}
    .controls {display:flex;gap:8px;flex-wrap:wrap}
    @media(max-width:900px){ .panel{grid-template-columns:1fr} }
    /* scrollbar */
    .broadcast-list::-webkit-scrollbar{width:8px}
    .broadcast-list::-webkit-scrollbar-thumb{background:#e6eefc;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="container">
      <h1>Telegram Broadcast â€” Full Controller</h1>

      <label>Pesan (text penuh akan dikirim):</label>
      <textarea id="message" placeholder="Tulis pesan untuk broadcast..."></textarea>

      <div class="row">
        <div class="col">
          <label>Delay (menit)</label>
          <input id="delay" type="number" value="5" min="1" />
        </div>
        <div class="col" style="max-width:220px">
          <label>Mode</label>
          <select id="mode">
            <option value="all">Kirim ke semua ID (default)</option>
            <option value="test">Mode Test (kirim cuma 1 id pertama)</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="btnCreate">âž• Tambah Broadcast (kirim langsung)</button>
        <button id="btnStopAll" class="stop">â›” Hentikan Semua</button>
        <button id="btnClearHistory" class="ghost">ðŸ§¾ Bersihkan Riwayat</button>
      </div>

      <div id="status">Status: siap</div>

      <div class="panel">
        <div class="left">
          <div class="card">
            <strong>Daftar Broadcast Aktif</strong>
            <div class="broadcast-list" id="broadcastList"></div>
            <div class="tiny" style="margin-top:8px">Setiap broadcast berjalan sendiri. Preview di UI: 5 kata pertama (tampilan). Pesan yang dikirim tetap full.</div>
          </div>

          <div class="card">
            <strong>Riwayat Pengiriman</strong>
            <div id="historyList"></div>
          </div>
        </div>

        <div class="right">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Kontrol & Info</div>
              <div class="tiny" style="margin-top:6px">Pengaturan disimpan otomatis di browser (localStorage).</div>
            </div>
            <div style="text-align:right">
              <div class="tiny">Token bot: <span class="pill">Tetap</span></div>
            </div>
          </div>

          <div style="margin-top:12px" class="card">
            <div style="font-weight:700">Preview Pesan (UI)</div>
            <div id="preview" style="margin-top:8px;padding:10px;border-radius:8px;background:#fff;border:1px solid #eef4fb;min-height:70px"></div>
          </div>

          <div style="margin-top:12px" class="card">
            <div style="font-weight:700">Cache / Statistik</div>
            <div class="tiny" style="margin-top:6px">Jumlah Chat ID (cache): <span id="cachedCount">-</span></div>
            <div class="tiny" style="margin-top:6px">Status koneksi fetch list ID akan terlihat saat kirim.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  PERINGATAN: Jangan ubah BOT_TOKEN dan LIST_ID_URL kecuali memang ingin mengganti.
  Keduanya sengaja dibiarkan seperti versi awal.
*/
const BOT_TOKEN = "7650117681:AAE-dNWtl0QjW3o6Sk_WndJWoe-947nimoY";
const LIST_ID_URL = "https://raw.githubusercontent.com/BimxyzDev/Bot-broadcast/main/id.json";

const STORAGE_KEY = "multiBroadcast_full_v2";
const HISTORY_KEY = "multiBroadcast_full_history_v2";

let broadcasts = {};   // map id -> broadcast object
let timers = {};       // map id -> setInterval id
let sendingFlags = {}; // map id -> boolean
let chatIdCache = null;

// --- UTIL: preview 5 kata
function previewText(text) {
  if (!text) return "";
  const words = text.trim().split(/\s+/);
  return words.length > 5 ? words.slice(0,5).join(" ") + "..." : text;
}

// --- Storage helpers
function loadFromStorage(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const arr = JSON.parse(raw);
    for(const b of arr){
      broadcasts[b.id] = Object.assign({}, {
        id: b.id,
        message: b.message,
        delayMinutes: b.delayMinutes,
        nextRun: b.nextRun,
        lastRun: b.lastRun || null,
        active: b.active !== false,
        successCountTotal: b.successCountTotal || 0,
        lastSuccessCount: b.lastSuccessCount || 0,
        statusText: b.statusText || 'idle'
      });
    }
  }catch(e){
    console.error("Load storage failed", e);
  }
}
function saveToStorage(){
  try{
    const arr = Object.values(broadcasts);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  }catch(e){ console.error(e) }
}

// --- History
function addHistory(entry){
  try{
    const raw = localStorage.getItem(HISTORY_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    arr.unshift(entry);
    if(arr.length > 80) arr.splice(80);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
    renderHistory();
  }catch(e){ console.error(e) }
}
function loadHistory(){ try{ const raw = localStorage.getItem(HISTORY_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ return []; } }
function renderHistory(){
  const hist = loadHistory();
  const el = document.getElementById("historyList");
  el.innerHTML = "";
  if(hist.length === 0){ el.innerHTML = "<div class='tiny'>Belum ada riwayat.</div>"; return; }
  for(const h of hist.slice(0,40)){
    const d = document.createElement("div");
    d.className = "history-item";
    d.innerHTML = `<div style="font-weight:700">${escapeHtml(h.message).slice(0,80)}</div>
                   <div class="tiny">Terkirim: <strong>${h.count}</strong> â€¢ Waktu: ${new Date(h.time).toLocaleString()}</div>`;
    el.appendChild(d);
  }
}

// --- UI render broadcasts
function renderBroadcasts(){
  const list = document.getElementById("broadcastList");
  list.innerHTML = "";
  const keys = Object.keys(broadcasts).sort((a,b)=> broadcasts[a].nextRun - broadcasts[b].nextRun);
  if(keys.length === 0){
    list.innerHTML = "<div class='tiny'>Belum ada broadcast aktif. Tambah pakai form di atas.</div>";
    document.getElementById("status").innerText = "Status: siap";
    return;
  }
  for(const k of keys){
    const b = broadcasts[k];
    const item = document.createElement("div");
    item.className = "b-item";

    // left
    const left = document.createElement("div"); left.className = "b-left";
    const badge = document.createElement("div"); badge.className = "badge msg"; badge.innerText = (b.message||"").slice(0,2).toUpperCase();
    const meta = document.createElement("div"); meta.className = "b-meta";
    const title = document.createElement("div"); title.className = "title"; title.innerText = previewText(b.message);
    const small = document.createElement("div"); small.className = "small"; small.innerText = `Delay ${b.delayMinutes}m â€¢ Total sukses: ${b.successCountTotal}`;
    meta.appendChild(title); meta.appendChild(small);
    left.appendChild(badge); left.appendChild(meta);

    // right
    const right = document.createElement("div"); right.className = "b-right";
    const cd = document.createElement("div"); cd.className = "countdown"; cd.id = "cd_"+b.id; cd.innerText = formatCountdown(b.nextRun - Date.now());
    const st = document.createElement("div"); st.className = (b.statusText === "sending") ? "status-sending" : "status-idle"; st.innerText = (b.statusText === "sending") ? "SENDING..." : "Idle";
    const btnStop = document.createElement("button"); btnStop.style.marginTop="8px"; btnStop.style.padding="6px 8px"; btnStop.style.borderRadius="8px";
    btnStop.style.background="#ef4444"; btnStop.style.color="#fff"; btnStop.innerText = "â›” Stop";
    btnStop.onclick = ()=> stopSingleBroadcast(b.id);
    right.appendChild(cd); right.appendChild(st); right.appendChild(btnStop);

    item.appendChild(left); item.appendChild(right);
    list.appendChild(item);
  }
}

// --- Countdown formatter
function formatCountdown(ms){
  if(ms <= 0) return "00:00";
  const s = Math.floor(ms/1000);
  const days = Math.floor(s/86400);
  const hrs = Math.floor((s%86400)/3600);
  const mins = Math.floor((s%3600)/60);
  const secs = s%60;
  if(days>0) return `${days}d ${hrs}h`;
  if(hrs>0) return `${hrs}h ${mins}m`;
  return `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
}

// --- Create broadcast object & start
function createBroadcast(message, delayMinutes){
  const id = 'b_'+Date.now()+'_'+Math.floor(Math.random()*9000+1000);
  const now = Date.now();
  const b = {
    id,
    message,
    delayMinutes: Number(delayMinutes),
    nextRun: now + Number(delayMinutes) * 60 * 1000, // will be updated after immediate send
    lastRun: null,
    active: true,
    successCountTotal: 0,
    lastSuccessCount: 0,
    statusText: 'idle'
  };
  broadcasts[id] = b;
  saveToStorage();
  startTimerForBroadcast(id);
  renderBroadcasts();
  updatePreview();
  // immediate send (first)
  triggerImmediateSend(id);
  return id;
}

// --- Immediate send (first message) then schedule nextRun
async function triggerImmediateSend(id){
  const b = broadcasts[id];
  if(!b || sendingFlags[id]) return;
  sendingFlags[id] = true;
  b.statusText = "sending";
  updateStatus(`Mengirim (pertama) "${b.message.slice(0,40)}..."`);
  renderBroadcasts();
  try{
    const successCount = await performSendForBroadcast(id);
    b.lastRun = Date.now();
    b.lastSuccessCount = successCount;
    b.successCountTotal = (b.successCountTotal||0) + successCount;
    b.nextRun = Date.now() + b.delayMinutes * 60 * 1000;
    b.statusText = "idle";
    saveToStorage();
    addHistory({ message: b.message, count: successCount, time: Date.now() });
    updateStatus(`Selesai kirim pertama â†’ ${successCount} sukses`);
    renderBroadcasts();
  }catch(err){
    console.error(err);
  }finally{
    sendingFlags[id] = false;
  }
}

// --- Start per-broadcast timer for subsequent runs
function startTimerForBroadcast(id){
  if(timers[id]) return;
  timers[id] = setInterval(async ()=>{
    const b = broadcasts[id];
    if(!b){ clearInterval(timers[id]); delete timers[id]; return;}
    const cdEl = document.getElementById("cd_"+b.id);
    if(cdEl) cdEl.innerText = formatCountdown(b.nextRun - Date.now());
    if(b.active && !sendingFlags[id] && Date.now() >= b.nextRun - 50){
      sendingFlags[id] = true;
      b.statusText = "sending";
      updateStatus(`Mengirim "${b.message.slice(0,40)}..."`);
      renderBroadcasts();
      try{
        const successCount = await performSendForBroadcast(id);
        b.lastRun = Date.now();
        b.lastSuccessCount = successCount;
        b.successCountTotal = (b.successCountTotal||0) + successCount;
        b.nextRun = Date.now() + b.delayMinutes * 60 * 1000;
        b.statusText = "idle";
        saveToStorage();
        addHistory({ message: b.message, count: successCount, time: Date.now() });
        updateStatus(`Selesai kirim â†’ ${successCount} sukses`);
        renderBroadcasts();
      }catch(e){
        console.error(e);
      }finally{
        sendingFlags[id] = false;
      }
    }
  }, 1000);
}

// --- Stop single broadcast
function stopSingleBroadcast(id){
  if(!broadcasts[id]) return;
  if(timers[id]){ clearInterval(timers[id]); delete timers[id]; }
  delete broadcasts[id];
  saveToStorage();
  renderBroadcasts();
  updateStatus("Broadcast dihentikan");
}

// --- Stop all
function stopAllBroadcasts(){
  for(const t in timers){ clearInterval(timers[t]); }
  timers = {};
  broadcasts = {};
  saveToStorage();
  renderBroadcasts();
  updateStatus("Semua broadcast dihentikan");
}

// --- Perform send action for given broadcast (returns success count)
async function performSendForBroadcast(id){
  const b = broadcasts[id];
  if(!b) return 0;
  let chatIds = chatIdCache;
  try{
    if(!chatIds){
      const r = await fetch(LIST_ID_URL);
      chatIds = await r.json();
      chatIdCache = chatIds;
      document.getElementById("cachedCount").innerText = Array.isArray(chatIds) ? chatIds.length : "-";
    }
  }catch(e){
    console.error("Fetch chat id failed", e);
    chatIdCache = null;
    document.getElementById("cachedCount").innerText = "-";
    return 0;
  }
  if(!Array.isArray(chatIds) || chatIds.length === 0) return 0;
  const mode = document.getElementById("mode").value;
  if(mode === "test") chatIds = chatIds.slice(0,1);
  let success = 0;
  for(const cid of chatIds){
    if(!broadcasts[id]) break; // stopped while sending
    try{
      const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ chat_id: cid, text: b.message })
      });
      if(res.ok) success++;
    }catch(e){
      // ignore per-id errors
    }
    // short delay to avoid burst
    await new Promise(r=>setTimeout(r, 500));
  }
  return success;
}

// --- UI preview & helpers
function updatePreview(){
  const msg = document.getElementById("message").value.trim();
  document.getElementById("preview").innerText = previewText(msg || "(kosong)");
}
function updateStatus(txt){
  document.getElementById("status").innerText = "Status: " + txt;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

// --- Init timers from saved data
function initAllTimers(){
  // clear existing
  for(const id in timers){ clearInterval(timers[id]); delete timers[id]; }
  for(const id in broadcasts){ startTimerForBroadcast(id); }
  renderBroadcasts();
  renderHistory();
}

// --- Handlers for UI
document.getElementById("btnCreate").addEventListener("click", ()=>{
  const msg = document.getElementById("message").value.trim();
  const delay = Math.max(1, Number(document.getElementById("delay").value) || 1);
  if(!msg){ alert("Pesan tidak boleh kosong"); return; }
  createBroadcast(msg, delay);
  document.getElementById("message").value = ""; updatePreview();
});
document.getElementById("btnStopAll").addEventListener("click", ()=>{
  if(confirm("Hentikan semua broadcast aktif?")) stopAllBroadcasts();
});
document.getElementById("btnClearHistory").addEventListener("click", ()=>{
  if(confirm("Bersihkan riwayat broadcast?")){ localStorage.removeItem(HISTORY_KEY); renderHistory(); }
});
document.getElementById("message").addEventListener("input", updatePreview);

// disable ctrl+wheel zoom & zoom keys (double protection)
document.addEventListener('wheel', e => { if(e.ctrlKey) e.preventDefault(); }, { passive:false });
document.addEventListener('keydown', e => {
  if(e.ctrlKey && (e.key === '+' || e.key === '-' || e.key === '=')) e.preventDefault();
});

// On load
window.addEventListener("load", async ()=>{
  loadFromStorage();
  // try fetch chatIds once to show count
  try{
    const r = await fetch(LIST_ID_URL);
    const ids = await r.json();
    chatIdCache = ids;
    document.getElementById("cachedCount").innerText = Array.isArray(ids) ? ids.length : "-";
  }catch(e){
    document.getElementById("cachedCount").innerText = "-";
  }
  updatePreview();
  renderHistory();
  initAllTimers();
});
</script>
</body>
  </html>
